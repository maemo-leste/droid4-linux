#!/bin/bash
#
# start PVR SGX GPU
# and run some demo
#
# usage: gpu-demo
#
# WARNING: this loads and installs packages with NON-FREE
# firmware for the SGX libraries and runtime support from
#
# http://download.goldelico.com/letux-debian-rootfs/debian/dists/jessie/main/binary-armhf/
#
# It needs a kernel where the GPL'ed SGX kernel driver is
# properly configured.
#

SCRIPTPATH="$(dirname "$0")"

# we need a more recent libdrm2 on plain jessie
case $(dpkg -s libdrm2 2>/dev/null | grep '^Version:') in
	'' | 'Version: '2.4.58-* )
		apt-get -t jessie-backports install --reinstall libdrm2
		;;
esac

# autodetect package version to load
COMPATIBLE=omap_$(egrep -ao '[a-z0-9]*-sgx[0-9]*-[0-9]*' </proc/device-tree/ocp*/*g*x@*/compatible | tr '-' '_')	# match gfx@ and sgx@
MODULE=pvrsrvkm_$COMPATIBLE
echo compatible driver: $COMPATIBLE
echo module name: $MODULE

# fetch the microkernel binary and libraries
[ "$(which pvrsrvctl)" ] || apt-get install -y --force-yes omap-pvrsgx-1.14

# if kernel module was blacklisted, load it now
lsmod | fgrep -q pvrsrvkm_ || modprobe $MODULE

# fix clock setup
# should have been done by driver, hwmods and pdata-quirks
if fgrep -q AM33XX </proc/cpuinfo
then
	: seems to work now with CM_GFX_L3_CLKSTCTRL / CM_GFX_GFX_CLKCTRL hack
	# devmem2 0x44E00900 w 0x02
	# devmem2 0x44E00904 w 0x02
	# devmem2 0x44E0090c w 0x02
	# devmem2 0x44E00910 w 0x02
	# devmem2 0x44E00914 w 0x02
else
	: no fix needed
fi

# start pvr
: which pvrsrvctl
fgrep -q 'System Version String: None' /proc/pvr/version && pvrsrvctl --start --no-module

fgrep "System Version String: " /proc/pvr/version

PATH=$PATH:/opt/img-powervr-sdk/Examples/Advanced/NullWS/

. $SCRIPTPATH/x	# needed by eglinfo

for i in sgx_clipblit_test gles1test1 gles2test1 eglinfo kmscube OGLES2Water
do
	if [ "$(which $i)" ]
	then
		echo "*** $0: running $i ***"
		timeout 10 $i
	fi
done

# pvrsrvctl --stop
